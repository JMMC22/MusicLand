'use strict';function cov_21trel8eph(){var path="C:\\Users\\jmmar\\OneDrive\\Documentos\\Documents\\INGENIERIA INFORM\xC1TICA 4\xBA\\2DO CUATRIMESTRE\\TFG\\repo\\red-social\\api\\controllers\\publication.js";var hash="d3a95b4d4758565aab84c5100151d363a98aa99b";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"C:\\Users\\jmmar\\OneDrive\\Documentos\\Documents\\INGENIERIA INFORM\xC1TICA 4\xBA\\2DO CUATRIMESTRE\\TFG\\repo\\red-social\\api\\controllers\\publication.js",statementMap:{"0":{start:{line:3,column:25},end:{line:3,column:55}},"1":{start:{line:4,column:9},end:{line:4,column:22}},"2":{start:{line:5,column:11},end:{line:5,column:26}},"3":{start:{line:6,column:13},end:{line:6,column:30}},"4":{start:{line:8,column:18},end:{line:8,column:50}},"5":{start:{line:9,column:11},end:{line:9,column:36}},"6":{start:{line:10,column:13},end:{line:10,column:40}},"7":{start:{line:11,column:11},end:{line:11,column:36}},"8":{start:{line:17,column:17},end:{line:17,column:25}},"9":{start:{line:19,column:22},end:{line:19,column:39}},"10":{start:{line:21,column:4},end:{line:25,column:5}},"11":{start:{line:22,column:8},end:{line:22,column:72}},"12":{start:{line:24,column:8},end:{line:24,column:39}},"13":{start:{line:27,column:4},end:{line:31,column:5}},"14":{start:{line:28,column:8},end:{line:28,column:32}},"15":{start:{line:30,column:8},end:{line:30,column:39}},"16":{start:{line:33,column:4},end:{line:33,column:45}},"17":{start:{line:35,column:4},end:{line:35,column:36}},"18":{start:{line:37,column:4},end:{line:41,column:5}},"19":{start:{line:38,column:8},end:{line:38,column:32}},"20":{start:{line:40,column:8},end:{line:40,column:39}},"21":{start:{line:44,column:4},end:{line:50,column:7}},"22":{start:{line:45,column:8},end:{line:45,column:83}},"23":{start:{line:45,column:17},end:{line:45,column:83}},"24":{start:{line:47,column:8},end:{line:47,column:112}},"25":{start:{line:47,column:32},end:{line:47,column:112}},"26":{start:{line:49,column:8},end:{line:49,column:72}},"27":{start:{line:56,column:15},end:{line:56,column:16}},"28":{start:{line:57,column:4},end:{line:59,column:5}},"29":{start:{line:58,column:8},end:{line:58,column:31}},"30":{start:{line:60,column:23},end:{line:60,column:24}},"31":{start:{line:63,column:4},end:{line:87,column:6}},"32":{start:{line:64,column:8},end:{line:64,column:83}},"33":{start:{line:64,column:17},end:{line:64,column:83}},"34":{start:{line:66,column:28},end:{line:66,column:30}},"35":{start:{line:68,column:8},end:{line:70,column:11}},"36":{start:{line:69,column:12},end:{line:69,column:48}},"37":{start:{line:72,column:8},end:{line:72,column:41}},"38":{start:{line:74,column:8},end:{line:85,column:10}},"39":{start:{line:75,column:12},end:{line:75,column:87}},"40":{start:{line:75,column:21},end:{line:75,column:87}},"41":{start:{line:77,column:12},end:{line:77,column:97}},"42":{start:{line:77,column:31},end:{line:77,column:97}},"43":{start:{line:79,column:12},end:{line:84,column:14}},"44":{start:{line:94,column:15},end:{line:94,column:16}},"45":{start:{line:95,column:4},end:{line:97,column:5}},"46":{start:{line:96,column:8},end:{line:96,column:31}},"47":{start:{line:98,column:23},end:{line:98,column:24}},"48":{start:{line:100,column:18},end:{line:100,column:30}},"49":{start:{line:101,column:4},end:{line:103,column:5}},"50":{start:{line:102,column:8},end:{line:102,column:34}},"51":{start:{line:105,column:4},end:{line:116,column:6}},"52":{start:{line:106,column:8},end:{line:106,column:83}},"53":{start:{line:106,column:17},end:{line:106,column:83}},"54":{start:{line:108,column:8},end:{line:108,column:93}},"55":{start:{line:108,column:27},end:{line:108,column:93}},"56":{start:{line:110,column:8},end:{line:115,column:10}},"57":{start:{line:123,column:24},end:{line:123,column:37}},"58":{start:{line:125,column:4},end:{line:133,column:6}},"59":{start:{line:126,column:8},end:{line:126,column:77}},"60":{start:{line:126,column:17},end:{line:126,column:77}},"61":{start:{line:128,column:8},end:{line:128,column:96}},"62":{start:{line:128,column:26},end:{line:128,column:96}},"63":{start:{line:130,column:8},end:{line:130,column:53}},"64":{start:{line:137,column:24},end:{line:137,column:37}},"65":{start:{line:139,column:4},end:{line:145,column:6}},"66":{start:{line:140,column:8},end:{line:140,column:77}},"67":{start:{line:140,column:17},end:{line:140,column:77}},"68":{start:{line:143,column:8},end:{line:143,column:74}},"69":{start:{line:149,column:24},end:{line:149,column:37}},"70":{start:{line:151,column:4},end:{line:187,column:5}},"71":{start:{line:152,column:24},end:{line:152,column:44}},"72":{start:{line:153,column:25},end:{line:153,column:46}},"73":{start:{line:155,column:24},end:{line:155,column:37}},"74":{start:{line:157,column:23},end:{line:157,column:44}},"75":{start:{line:158,column:23},end:{line:158,column:34}},"76":{start:{line:161,column:8},end:{line:184,column:9}},"77":{start:{line:163,column:12},end:{line:178,column:14}},"78":{start:{line:165,column:16},end:{line:177,column:17}},"79":{start:{line:166,column:20},end:{line:172,column:23}},"80":{start:{line:167,column:24},end:{line:167,column:99}},"81":{start:{line:167,column:33},end:{line:167,column:99}},"82":{start:{line:169,column:24},end:{line:169,column:140}},"83":{start:{line:169,column:49},end:{line:169,column:140}},"84":{start:{line:171,column:24},end:{line:171,column:82}},"85":{start:{line:175,column:20},end:{line:175,column:87}},"86":{start:{line:183,column:12},end:{line:183,column:80}},"87":{start:{line:186,column:8},end:{line:186,column:79}},"88":{start:{line:191,column:4},end:{line:194,column:6}},"89":{start:{line:192,column:8},end:{line:192,column:67}},"90":{start:{line:192,column:17},end:{line:192,column:67}},"91":{start:{line:198,column:20},end:{line:198,column:40}},"92":{start:{line:199,column:20},end:{line:199,column:57}},"93":{start:{line:201,column:4},end:{line:208,column:6}},"94":{start:{line:202,column:8},end:{line:207,column:9}},"95":{start:{line:203,column:12},end:{line:203,column:50}},"96":{start:{line:205,column:12},end:{line:205,column:74}},"97":{start:{line:213,column:4},end:{line:241,column:11}},"98":{start:{line:222,column:12},end:{line:222,column:87}},"99":{start:{line:222,column:21},end:{line:222,column:87}},"100":{start:{line:224,column:12},end:{line:224,column:98}},"101":{start:{line:224,column:24},end:{line:224,column:98}},"102":{start:{line:227,column:12},end:{line:236,column:14}},"103":{start:{line:228,column:16},end:{line:228,column:91}},"104":{start:{line:228,column:25},end:{line:228,column:91}},"105":{start:{line:230,column:16},end:{line:230,column:102}},"106":{start:{line:230,column:28},end:{line:230,column:102}},"107":{start:{line:232,column:16},end:{line:232,column:55}},"108":{start:{line:244,column:0},end:{line:255,column:1}}},fnMap:{"0":{name:"savePublication",decl:{start:{line:16,column:9},end:{line:16,column:24}},loc:{start:{line:16,column:35},end:{line:52,column:1}},line:16},"1":{name:"(anonymous_1)",decl:{start:{line:44,column:21},end:{line:44,column:22}},loc:{start:{line:44,column:49},end:{line:50,column:5}},line:44},"2":{name:"getPublicationTimeline",decl:{start:{line:54,column:9},end:{line:54,column:31}},loc:{start:{line:54,column:42},end:{line:90,column:1}},line:54},"3":{name:"(anonymous_3)",decl:{start:{line:63,column:66},end:{line:63,column:67}},loc:{start:{line:63,column:84},end:{line:87,column:5}},line:63},"4":{name:"(anonymous_4)",decl:{start:{line:68,column:24},end:{line:68,column:25}},loc:{start:{line:68,column:36},end:{line:70,column:9}},line:68},"5":{name:"(anonymous_5)",decl:{start:{line:74,column:194},end:{line:74,column:195}},loc:{start:{line:74,column:224},end:{line:85,column:9}},line:74},"6":{name:"getPublicationsUser",decl:{start:{line:92,column:9},end:{line:92,column:28}},loc:{start:{line:92,column:39},end:{line:118,column:1}},line:92},"7":{name:"(anonymous_7)",decl:{start:{line:105,column:173},end:{line:105,column:174}},loc:{start:{line:105,column:203},end:{line:116,column:5}},line:105},"8":{name:"getPublication",decl:{start:{line:122,column:9},end:{line:122,column:23}},loc:{start:{line:122,column:34},end:{line:134,column:1}},line:122},"9":{name:"(anonymous_9)",decl:{start:{line:125,column:40},end:{line:125,column:41}},loc:{start:{line:125,column:62},end:{line:133,column:5}},line:125},"10":{name:"deletePublication",decl:{start:{line:136,column:9},end:{line:136,column:26}},loc:{start:{line:136,column:37},end:{line:146,column:1}},line:136},"11":{name:"(anonymous_11)",decl:{start:{line:139,column:76},end:{line:139,column:77}},loc:{start:{line:139,column:83},end:{line:145,column:5}},line:139},"12":{name:"uploadImage",decl:{start:{line:148,column:9},end:{line:148,column:20}},loc:{start:{line:148,column:31},end:{line:188,column:1}},line:148},"13":{name:"(anonymous_13)",decl:{start:{line:163,column:85},end:{line:163,column:86}},loc:{start:{line:163,column:107},end:{line:178,column:13}},line:163},"14":{name:"(anonymous_14)",decl:{start:{line:166,column:101},end:{line:166,column:102}},loc:{start:{line:166,column:130},end:{line:172,column:21}},line:166},"15":{name:"removeFilesOfUploads",decl:{start:{line:190,column:9},end:{line:190,column:29}},loc:{start:{line:190,column:55},end:{line:195,column:1}},line:190},"16":{name:"(anonymous_16)",decl:{start:{line:191,column:25},end:{line:191,column:26}},loc:{start:{line:191,column:34},end:{line:194,column:5}},line:191},"17":{name:"getImageFile",decl:{start:{line:197,column:9},end:{line:197,column:21}},loc:{start:{line:197,column:32},end:{line:209,column:1}},line:197},"18":{name:"(anonymous_18)",decl:{start:{line:201,column:25},end:{line:201,column:26}},loc:{start:{line:201,column:36},end:{line:208,column:5}},line:201},"19":{name:"getTop3CancionesPublicadas",decl:{start:{line:211,column:9},end:{line:211,column:35}},loc:{start:{line:211,column:46},end:{line:242,column:1}},line:211},"20":{name:"(anonymous_20)",decl:{start:{line:221,column:96},end:{line:221,column:97}},loc:{start:{line:221,column:112},end:{line:241,column:9}},line:221},"21":{name:"(anonymous_21)",decl:{start:{line:227,column:50},end:{line:227,column:51}},loc:{start:{line:227,column:66},end:{line:236,column:13}},line:227}},branchMap:{"0":{loc:{start:{line:21,column:4},end:{line:25,column:5}},type:"if",locations:[{start:{line:21,column:4},end:{line:25,column:5}},{start:{line:21,column:4},end:{line:25,column:5}}],line:21},"1":{loc:{start:{line:27,column:4},end:{line:31,column:5}},type:"if",locations:[{start:{line:27,column:4},end:{line:31,column:5}},{start:{line:27,column:4},end:{line:31,column:5}}],line:27},"2":{loc:{start:{line:37,column:4},end:{line:41,column:5}},type:"if",locations:[{start:{line:37,column:4},end:{line:41,column:5}},{start:{line:37,column:4},end:{line:41,column:5}}],line:37},"3":{loc:{start:{line:45,column:8},end:{line:45,column:83}},type:"if",locations:[{start:{line:45,column:8},end:{line:45,column:83}},{start:{line:45,column:8},end:{line:45,column:83}}],line:45},"4":{loc:{start:{line:47,column:8},end:{line:47,column:112}},type:"if",locations:[{start:{line:47,column:8},end:{line:47,column:112}},{start:{line:47,column:8},end:{line:47,column:112}}],line:47},"5":{loc:{start:{line:57,column:4},end:{line:59,column:5}},type:"if",locations:[{start:{line:57,column:4},end:{line:59,column:5}},{start:{line:57,column:4},end:{line:59,column:5}}],line:57},"6":{loc:{start:{line:64,column:8},end:{line:64,column:83}},type:"if",locations:[{start:{line:64,column:8},end:{line:64,column:83}},{start:{line:64,column:8},end:{line:64,column:83}}],line:64},"7":{loc:{start:{line:75,column:12},end:{line:75,column:87}},type:"if",locations:[{start:{line:75,column:12},end:{line:75,column:87}},{start:{line:75,column:12},end:{line:75,column:87}}],line:75},"8":{loc:{start:{line:77,column:12},end:{line:77,column:97}},type:"if",locations:[{start:{line:77,column:12},end:{line:77,column:97}},{start:{line:77,column:12},end:{line:77,column:97}}],line:77},"9":{loc:{start:{line:95,column:4},end:{line:97,column:5}},type:"if",locations:[{start:{line:95,column:4},end:{line:97,column:5}},{start:{line:95,column:4},end:{line:97,column:5}}],line:95},"10":{loc:{start:{line:101,column:4},end:{line:103,column:5}},type:"if",locations:[{start:{line:101,column:4},end:{line:103,column:5}},{start:{line:101,column:4},end:{line:103,column:5}}],line:101},"11":{loc:{start:{line:106,column:8},end:{line:106,column:83}},type:"if",locations:[{start:{line:106,column:8},end:{line:106,column:83}},{start:{line:106,column:8},end:{line:106,column:83}}],line:106},"12":{loc:{start:{line:108,column:8},end:{line:108,column:93}},type:"if",locations:[{start:{line:108,column:8},end:{line:108,column:93}},{start:{line:108,column:8},end:{line:108,column:93}}],line:108},"13":{loc:{start:{line:126,column:8},end:{line:126,column:77}},type:"if",locations:[{start:{line:126,column:8},end:{line:126,column:77}},{start:{line:126,column:8},end:{line:126,column:77}}],line:126},"14":{loc:{start:{line:128,column:8},end:{line:128,column:96}},type:"if",locations:[{start:{line:128,column:8},end:{line:128,column:96}},{start:{line:128,column:8},end:{line:128,column:96}}],line:128},"15":{loc:{start:{line:140,column:8},end:{line:140,column:77}},type:"if",locations:[{start:{line:140,column:8},end:{line:140,column:77}},{start:{line:140,column:8},end:{line:140,column:77}}],line:140},"16":{loc:{start:{line:151,column:4},end:{line:187,column:5}},type:"if",locations:[{start:{line:151,column:4},end:{line:187,column:5}},{start:{line:151,column:4},end:{line:187,column:5}}],line:151},"17":{loc:{start:{line:161,column:8},end:{line:184,column:9}},type:"if",locations:[{start:{line:161,column:8},end:{line:184,column:9}},{start:{line:161,column:8},end:{line:184,column:9}}],line:161},"18":{loc:{start:{line:161,column:12},end:{line:161,column:50}},type:"binary-expr",locations:[{start:{line:161,column:12},end:{line:161,column:29}},{start:{line:161,column:33},end:{line:161,column:50}}],line:161},"19":{loc:{start:{line:165,column:16},end:{line:177,column:17}},type:"if",locations:[{start:{line:165,column:16},end:{line:177,column:17}},{start:{line:165,column:16},end:{line:177,column:17}}],line:165},"20":{loc:{start:{line:167,column:24},end:{line:167,column:99}},type:"if",locations:[{start:{line:167,column:24},end:{line:167,column:99}},{start:{line:167,column:24},end:{line:167,column:99}}],line:167},"21":{loc:{start:{line:169,column:24},end:{line:169,column:140}},type:"if",locations:[{start:{line:169,column:24},end:{line:169,column:140}},{start:{line:169,column:24},end:{line:169,column:140}}],line:169},"22":{loc:{start:{line:192,column:8},end:{line:192,column:67}},type:"if",locations:[{start:{line:192,column:8},end:{line:192,column:67}},{start:{line:192,column:8},end:{line:192,column:67}}],line:192},"23":{loc:{start:{line:202,column:8},end:{line:207,column:9}},type:"if",locations:[{start:{line:202,column:8},end:{line:207,column:9}},{start:{line:202,column:8},end:{line:207,column:9}}],line:202},"24":{loc:{start:{line:222,column:12},end:{line:222,column:87}},type:"if",locations:[{start:{line:222,column:12},end:{line:222,column:87}},{start:{line:222,column:12},end:{line:222,column:87}}],line:222},"25":{loc:{start:{line:224,column:12},end:{line:224,column:98}},type:"if",locations:[{start:{line:224,column:12},end:{line:224,column:98}},{start:{line:224,column:12},end:{line:224,column:98}}],line:224},"26":{loc:{start:{line:228,column:16},end:{line:228,column:91}},type:"if",locations:[{start:{line:228,column:16},end:{line:228,column:91}},{start:{line:228,column:16},end:{line:228,column:91}}],line:228},"27":{loc:{start:{line:230,column:16},end:{line:230,column:102}},type:"if",locations:[{start:{line:230,column:16},end:{line:230,column:102}},{start:{line:230,column:16},end:{line:230,column:102}}],line:230}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0,"50":0,"51":0,"52":0,"53":0,"54":0,"55":0,"56":0,"57":0,"58":0,"59":0,"60":0,"61":0,"62":0,"63":0,"64":0,"65":0,"66":0,"67":0,"68":0,"69":0,"70":0,"71":0,"72":0,"73":0,"74":0,"75":0,"76":0,"77":0,"78":0,"79":0,"80":0,"81":0,"82":0,"83":0,"84":0,"85":0,"86":0,"87":0,"88":0,"89":0,"90":0,"91":0,"92":0,"93":0,"94":0,"95":0,"96":0,"97":0,"98":0,"99":0,"100":0,"101":0,"102":0,"103":0,"104":0,"105":0,"106":0,"107":0,"108":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0},b:{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0],"8":[0,0],"9":[0,0],"10":[0,0],"11":[0,0],"12":[0,0],"13":[0,0],"14":[0,0],"15":[0,0],"16":[0,0],"17":[0,0],"18":[0,0],"19":[0,0],"20":[0,0],"21":[0,0],"22":[0,0],"23":[0,0],"24":[0,0],"25":[0,0],"26":[0,0],"27":[0,0]},_coverageSchema:"1a1c01bbd47fc00a2c39e90264f33305004495a9",hash:"d3a95b4d4758565aab84c5100151d363a98aa99b"};var coverage=global[gcv]||(global[gcv]={});if(!coverage[path]||coverage[path].hash!==hash){coverage[path]=coverageData;}var actualCoverage=coverage[path];cov_21trel8eph=function(){return actualCoverage;};return actualCoverage;}cov_21trel8eph();var mongoosePagination=(cov_21trel8eph().s[0]++,require('mongoose-pagination'));var fs=(cov_21trel8eph().s[1]++,require('fs'));var path=(cov_21trel8eph().s[2]++,require('path'));var moment=(cov_21trel8eph().s[3]++,require('moment'));var Publication=(cov_21trel8eph().s[4]++,require('../models/publication'));var User=(cov_21trel8eph().s[5]++,require('../models/user'));var Follow=(cov_21trel8eph().s[6]++,require('../models/follow'));var Song=(cov_21trel8eph().s[7]++,require('../models/song'));function savePublication(req,res){cov_21trel8eph().f[0]++;var params=(cov_21trel8eph().s[8]++,req.body);var publication=(cov_21trel8eph().s[9]++,new Publication());cov_21trel8eph().s[10]++;if(!params.text){cov_21trel8eph().b[0][0]++;cov_21trel8eph().s[11]++;publication.text="Recomiendo esta canción a mis seguidores!!!";}else{cov_21trel8eph().b[0][1]++;cov_21trel8eph().s[12]++;publication.text=params.text;}cov_21trel8eph().s[13]++;if(!params.file){cov_21trel8eph().b[1][0]++;cov_21trel8eph().s[14]++;publication.file=null;}else{cov_21trel8eph().b[1][1]++;cov_21trel8eph().s[15]++;publication.file=params.file;}cov_21trel8eph().s[16]++;publication.created_at=moment().unix();cov_21trel8eph().s[17]++;publication.user=req.user.sub;cov_21trel8eph().s[18]++;if(!params.song){cov_21trel8eph().b[2][0]++;cov_21trel8eph().s[19]++;publication.song=null;}else{cov_21trel8eph().b[2][1]++;cov_21trel8eph().s[20]++;publication.song=params.song;}cov_21trel8eph().s[21]++;publication.save((err,publicationStored)=>{cov_21trel8eph().f[1]++;cov_21trel8eph().s[22]++;if(err){cov_21trel8eph().b[3][0]++;cov_21trel8eph().s[23]++;return res.status(500).send({message:'Error en la petición.'});}else{cov_21trel8eph().b[3][1]++;}cov_21trel8eph().s[24]++;if(!publicationStored){cov_21trel8eph().b[4][0]++;cov_21trel8eph().s[25]++;return res.status(404).send({message:'La publicación NO ha sido guardada.'});}else{cov_21trel8eph().b[4][1]++;}cov_21trel8eph().s[26]++;return res.status(200).send({publication:publicationStored});});}function getPublicationTimeline(req,res){cov_21trel8eph().f[2]++;var page=(cov_21trel8eph().s[27]++,1);cov_21trel8eph().s[28]++;if(req.params.page){cov_21trel8eph().b[5][0]++;cov_21trel8eph().s[29]++;page=req.params.page;}else{cov_21trel8eph().b[5][1]++;}var itemsPerPage=(cov_21trel8eph().s[30]++,5);cov_21trel8eph().s[31]++;Follow.find({user:req.user.sub}).populate('followed').exec((err,follows)=>{cov_21trel8eph().f[3]++;cov_21trel8eph().s[32]++;if(err){cov_21trel8eph().b[6][0]++;cov_21trel8eph().s[33]++;return res.status(500).send({message:'Error en la petición.'});}else{cov_21trel8eph().b[6][1]++;}var follows_clean=(cov_21trel8eph().s[34]++,[]);cov_21trel8eph().s[35]++;follows.forEach(follow=>{cov_21trel8eph().f[4]++;cov_21trel8eph().s[36]++;follows_clean.push(follow.followed);});cov_21trel8eph().s[37]++;follows_clean.push(req.user.sub);cov_21trel8eph().s[38]++;Publication.find({user:{"$in":follows_clean}}).sort('-created_at').populate('user song file').populate({path:'song',populate:{path:'artist'}}).paginate(page,itemsPerPage,(err,publications,total)=>{cov_21trel8eph().f[5]++;cov_21trel8eph().s[39]++;if(err){cov_21trel8eph().b[7][0]++;cov_21trel8eph().s[40]++;return res.status(500).send({message:'Error en la petición.'});}else{cov_21trel8eph().b[7][1]++;}cov_21trel8eph().s[41]++;if(!publications){cov_21trel8eph().b[8][0]++;cov_21trel8eph().s[42]++;return res.status(404).send({message:'No hay publicaciones.'});}else{cov_21trel8eph().b[8][1]++;}cov_21trel8eph().s[43]++;return res.status(200).send({total:total,pages:Math.ceil(total/itemsPerPage),page:page,publications:publications});});});}function getPublicationsUser(req,res){cov_21trel8eph().f[6]++;var page=(cov_21trel8eph().s[44]++,1);cov_21trel8eph().s[45]++;if(req.params.page){cov_21trel8eph().b[9][0]++;cov_21trel8eph().s[46]++;page=req.params.page;}else{cov_21trel8eph().b[9][1]++;}var itemsPerPage=(cov_21trel8eph().s[47]++,5);var user_id=(cov_21trel8eph().s[48]++,req.user.sub);cov_21trel8eph().s[49]++;if(req.params.user){cov_21trel8eph().b[10][0]++;cov_21trel8eph().s[50]++;user_id=req.params.user;}else{cov_21trel8eph().b[10][1]++;}cov_21trel8eph().s[51]++;Publication.find({user:user_id}).sort('-created_at').populate('user song file').populate({path:'song',populate:{path:'artist'}}).paginate(page,itemsPerPage,(err,publications,total)=>{cov_21trel8eph().f[7]++;cov_21trel8eph().s[52]++;if(err){cov_21trel8eph().b[11][0]++;cov_21trel8eph().s[53]++;return res.status(500).send({message:'Error en la petición.'});}else{cov_21trel8eph().b[11][1]++;}cov_21trel8eph().s[54]++;if(!publications){cov_21trel8eph().b[12][0]++;cov_21trel8eph().s[55]++;return res.status(404).send({message:'No hay publicaciones.'});}else{cov_21trel8eph().b[12][1]++;}cov_21trel8eph().s[56]++;return res.status(200).send({total:total,pages:Math.ceil(total/itemsPerPage),page:page,publications:publications});});}function getPublication(req,res){cov_21trel8eph().f[8]++;var publicationId=(cov_21trel8eph().s[57]++,req.params.id);cov_21trel8eph().s[58]++;Publication.findById(publicationId,(err,publication)=>{cov_21trel8eph().f[9]++;cov_21trel8eph().s[59]++;if(err){cov_21trel8eph().b[13][0]++;cov_21trel8eph().s[60]++;return res.status(500).send({message:'Error petición.'});}else{cov_21trel8eph().b[13][1]++;}cov_21trel8eph().s[61]++;if(!publication){cov_21trel8eph().b[14][0]++;cov_21trel8eph().s[62]++;return res.status(404).send({message:'La publicación no existe.'});}else{cov_21trel8eph().b[14][1]++;}cov_21trel8eph().s[63]++;return res.status(200).send({publication});});}function deletePublication(req,res){cov_21trel8eph().f[10]++;var publicationId=(cov_21trel8eph().s[64]++,req.params.id);cov_21trel8eph().s[65]++;Publication.find({'user':req.user.sub,'_id':publicationId}).remove(err=>{cov_21trel8eph().f[11]++;cov_21trel8eph().s[66]++;if(err){cov_21trel8eph().b[15][0]++;cov_21trel8eph().s[67]++;return res.status(500).send({message:'Error petición.'});}else{cov_21trel8eph().b[15][1]++;}//if (!publicationRemoved) return res.status(404).send({ message: 'La publicación no se ha eliminado.' });
cov_21trel8eph().s[68]++;return res.status(200).send({message:'Publicaión eliminada.'});});}function uploadImage(req,res){cov_21trel8eph().f[12]++;var publicationId=(cov_21trel8eph().s[69]++,req.params.id);cov_21trel8eph().s[70]++;if(req.files){cov_21trel8eph().b[16][0]++;var file_path=(cov_21trel8eph().s[71]++,req.files.image.path);var file_split=(cov_21trel8eph().s[72]++,file_path.split('\\'));var file_name=(cov_21trel8eph().s[73]++,file_split[2]);var ext_file=(cov_21trel8eph().s[74]++,file_name.split('\.'));var file_ext=(cov_21trel8eph().s[75]++,ext_file[1]);cov_21trel8eph().s[76]++;if((cov_21trel8eph().b[18][0]++,file_ext=='png')||(cov_21trel8eph().b[18][1]++,file_ext=='jpg')){cov_21trel8eph().b[17][0]++;cov_21trel8eph().s[77]++;Publication.findOne({'user':req.user.sub,'_id':publicationId}).exec((err,publication)=>{cov_21trel8eph().f[13]++;cov_21trel8eph().s[78]++;if(publication){cov_21trel8eph().b[19][0]++;cov_21trel8eph().s[79]++;Publication.findByIdAndUpdate(publicationId,{file:file_name},{new:true},(err,publicationUpdated)=>{cov_21trel8eph().f[14]++;cov_21trel8eph().s[80]++;if(err){cov_21trel8eph().b[20][0]++;cov_21trel8eph().s[81]++;return res.status(500).send({message:'Error en la petición.'});}else{cov_21trel8eph().b[20][1]++;}cov_21trel8eph().s[82]++;if(!publicationUpdated){cov_21trel8eph().b[21][0]++;cov_21trel8eph().s[83]++;return res.status(404).send({message:'No se ha podido actualizar imagen del usuario.'});}else{cov_21trel8eph().b[21][1]++;}cov_21trel8eph().s[84]++;return res.status(200).send({user:publicationUpdated});});}else{cov_21trel8eph().b[19][1]++;cov_21trel8eph().s[85]++;return removeFilesOfUploads(res,file_path,'No tienes permisos.');}});}else{cov_21trel8eph().b[17][1]++;cov_21trel8eph().s[86]++;return removeFilesOfUploads(res,file_path,'Extensión no válida.');}}else{cov_21trel8eph().b[16][1]++;cov_21trel8eph().s[87]++;return res.status(500).send({message:'No se han subido imágenes.'});}}function removeFilesOfUploads(res,file_path,message){cov_21trel8eph().f[15]++;cov_21trel8eph().s[88]++;fs.unlink(file_path,err=>{cov_21trel8eph().f[16]++;cov_21trel8eph().s[89]++;if(err){cov_21trel8eph().b[22][0]++;cov_21trel8eph().s[90]++;return res.status(500).send({message:message});}else{cov_21trel8eph().b[22][1]++;}});}function getImageFile(req,res){cov_21trel8eph().f[17]++;var imageFile=(cov_21trel8eph().s[91]++,req.params.imageFile);var path_file=(cov_21trel8eph().s[92]++,'./uploads/publications/'+imageFile);cov_21trel8eph().s[93]++;fs.exists(path_file,exits=>{cov_21trel8eph().f[18]++;cov_21trel8eph().s[94]++;if(exits){cov_21trel8eph().b[23][0]++;cov_21trel8eph().s[95]++;res.sendFile(path.resolve(path_file));}else{cov_21trel8eph().b[23][1]++;cov_21trel8eph().s[96]++;return res.status(500).send({message:'No existe imagen.'});}});}function getTop3CancionesPublicadas(req,res){cov_21trel8eph().f[19]++;cov_21trel8eph().s[97]++;Publication.aggregate([{$match:{"song":{"$exists":true,"$ne":null}}},{$group:{_id:"$song",count:{$sum:1}}}]).sort({count:-1}).limit(3).exec((err,songs)=>{cov_21trel8eph().f[20]++;cov_21trel8eph().s[98]++;if(err){cov_21trel8eph().b[24][0]++;cov_21trel8eph().s[99]++;return res.status(500).send({message:'Error en la petición.'});}else{cov_21trel8eph().b[24][1]++;}cov_21trel8eph().s[100]++;if(!songs){cov_21trel8eph().b[25][0]++;cov_21trel8eph().s[101]++;return res.status(404).send({message:'No hay canciones disponibles.'});}else{cov_21trel8eph().b[25][1]++;}cov_21trel8eph().s[102]++;Song.populate(songs,{path:'_id'},(err,songs)=>{cov_21trel8eph().f[21]++;cov_21trel8eph().s[103]++;if(err){cov_21trel8eph().b[26][0]++;cov_21trel8eph().s[104]++;return res.status(500).send({message:'Error en la petición.'});}else{cov_21trel8eph().b[26][1]++;}cov_21trel8eph().s[105]++;if(!songs){cov_21trel8eph().b[27][0]++;cov_21trel8eph().s[106]++;return res.status(404).send({message:'No hay canciones disponibles.'});}else{cov_21trel8eph().b[27][1]++;}cov_21trel8eph().s[107]++;return res.status(200).send({songs});});});}cov_21trel8eph().s[108]++;module.exports={savePublication,getPublicationTimeline,getPublication,deletePublication,uploadImage,getImageFile,getPublicationsUser,getTop3CancionesPublicadas};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInB1YmxpY2F0aW9uLmpzIl0sIm5hbWVzIjpbIm1vbmdvb3NlUGFnaW5hdGlvbiIsInJlcXVpcmUiLCJmcyIsInBhdGgiLCJtb21lbnQiLCJQdWJsaWNhdGlvbiIsIlVzZXIiLCJGb2xsb3ciLCJTb25nIiwic2F2ZVB1YmxpY2F0aW9uIiwicmVxIiwicmVzIiwicGFyYW1zIiwiYm9keSIsInB1YmxpY2F0aW9uIiwidGV4dCIsImZpbGUiLCJjcmVhdGVkX2F0IiwidW5peCIsInVzZXIiLCJzdWIiLCJzb25nIiwic2F2ZSIsImVyciIsInB1YmxpY2F0aW9uU3RvcmVkIiwic3RhdHVzIiwic2VuZCIsIm1lc3NhZ2UiLCJnZXRQdWJsaWNhdGlvblRpbWVsaW5lIiwicGFnZSIsIml0ZW1zUGVyUGFnZSIsImZpbmQiLCJwb3B1bGF0ZSIsImV4ZWMiLCJmb2xsb3dzIiwiZm9sbG93c19jbGVhbiIsImZvckVhY2giLCJmb2xsb3ciLCJwdXNoIiwiZm9sbG93ZWQiLCJzb3J0IiwicGFnaW5hdGUiLCJwdWJsaWNhdGlvbnMiLCJ0b3RhbCIsInBhZ2VzIiwiTWF0aCIsImNlaWwiLCJnZXRQdWJsaWNhdGlvbnNVc2VyIiwidXNlcl9pZCIsImdldFB1YmxpY2F0aW9uIiwicHVibGljYXRpb25JZCIsImlkIiwiZmluZEJ5SWQiLCJkZWxldGVQdWJsaWNhdGlvbiIsInJlbW92ZSIsInVwbG9hZEltYWdlIiwiZmlsZXMiLCJmaWxlX3BhdGgiLCJpbWFnZSIsImZpbGVfc3BsaXQiLCJzcGxpdCIsImZpbGVfbmFtZSIsImV4dF9maWxlIiwiZmlsZV9leHQiLCJmaW5kT25lIiwiZmluZEJ5SWRBbmRVcGRhdGUiLCJuZXciLCJwdWJsaWNhdGlvblVwZGF0ZWQiLCJyZW1vdmVGaWxlc09mVXBsb2FkcyIsInVubGluayIsImdldEltYWdlRmlsZSIsImltYWdlRmlsZSIsInBhdGhfZmlsZSIsImV4aXN0cyIsImV4aXRzIiwic2VuZEZpbGUiLCJyZXNvbHZlIiwiZ2V0VG9wM0NhbmNpb25lc1B1YmxpY2FkYXMiLCJhZ2dyZWdhdGUiLCIkbWF0Y2giLCIkZ3JvdXAiLCJfaWQiLCJjb3VudCIsIiRzdW0iLCJsaW1pdCIsInNvbmdzIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUEsYSx1NWhCQUVBLEdBQUlBLENBQUFBLGtCQUFrQiwwQkFBR0MsT0FBTyxDQUFDLHFCQUFELENBQVYsQ0FBdEIsQ0FDQSxHQUFJQyxDQUFBQSxFQUFFLDBCQUFHRCxPQUFPLENBQUMsSUFBRCxDQUFWLENBQU4sQ0FDQSxHQUFJRSxDQUFBQSxJQUFJLDBCQUFHRixPQUFPLENBQUMsTUFBRCxDQUFWLENBQVIsQ0FDQSxHQUFJRyxDQUFBQSxNQUFNLDBCQUFHSCxPQUFPLENBQUMsUUFBRCxDQUFWLENBQVYsQ0FFQSxHQUFJSSxDQUFBQSxXQUFXLDBCQUFHSixPQUFPLENBQUMsdUJBQUQsQ0FBVixDQUFmLENBQ0EsR0FBSUssQ0FBQUEsSUFBSSwwQkFBR0wsT0FBTyxDQUFDLGdCQUFELENBQVYsQ0FBUixDQUNBLEdBQUlNLENBQUFBLE1BQU0sMEJBQUdOLE9BQU8sQ0FBQyxrQkFBRCxDQUFWLENBQVYsQ0FDQSxHQUFJTyxDQUFBQSxJQUFJLDBCQUFHUCxPQUFPLENBQUMsZ0JBQUQsQ0FBVixDQUFSLENBS0EsUUFBU1EsQ0FBQUEsZUFBVCxDQUF5QkMsR0FBekIsQ0FBOEJDLEdBQTlCLENBQW1DLHlCQUMvQixHQUFJQyxDQUFBQSxNQUFNLDBCQUFHRixHQUFHLENBQUNHLElBQVAsQ0FBVixDQUVBLEdBQUlDLENBQUFBLFdBQVcsMEJBQUcsR0FBSVQsQ0FBQUEsV0FBSixFQUFILENBQWYsQ0FIK0IseUJBSy9CLEdBQUksQ0FBQ08sTUFBTSxDQUFDRyxJQUFaLENBQWtCLHFEQUNkRCxXQUFXLENBQUNDLElBQVosQ0FBbUIsNkNBQW5CLENBQ0gsQ0FGRCxJQUVPLHFEQUNIRCxXQUFXLENBQUNDLElBQVosQ0FBbUJILE1BQU0sQ0FBQ0csSUFBMUIsQ0FDSCxDQVQ4Qix5QkFXL0IsR0FBSSxDQUFDSCxNQUFNLENBQUNJLElBQVosQ0FBa0IscURBQ2RGLFdBQVcsQ0FBQ0UsSUFBWixDQUFtQixJQUFuQixDQUNILENBRkQsSUFFTyxxREFDSEYsV0FBVyxDQUFDRSxJQUFaLENBQW1CSixNQUFNLENBQUNJLElBQTFCLENBQ0gsQ0FmOEIseUJBaUIvQkYsV0FBVyxDQUFDRyxVQUFaLENBQXlCYixNQUFNLEdBQUdjLElBQVQsRUFBekIsQ0FqQitCLHlCQW1CL0JKLFdBQVcsQ0FBQ0ssSUFBWixDQUFtQlQsR0FBRyxDQUFDUyxJQUFKLENBQVNDLEdBQTVCLENBbkIrQix5QkFxQi9CLEdBQUksQ0FBQ1IsTUFBTSxDQUFDUyxJQUFaLENBQWtCLHFEQUNkUCxXQUFXLENBQUNPLElBQVosQ0FBbUIsSUFBbkIsQ0FDSCxDQUZELElBRU8scURBQ0hQLFdBQVcsQ0FBQ08sSUFBWixDQUFtQlQsTUFBTSxDQUFDUyxJQUExQixDQUNILENBekI4Qix5QkE0Qi9CUCxXQUFXLENBQUNRLElBQVosQ0FBaUIsQ0FBQ0MsR0FBRCxDQUFNQyxpQkFBTixHQUE0QixrREFDekMsR0FBSUQsR0FBSixDQUFTLDJEQUFPWixDQUFBQSxHQUFHLENBQUNjLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQixDQUFFQyxPQUFPLENBQUUsdUJBQVgsQ0FBckIsQ0FBUCxDQUFrRSxDQUEzRSxpQ0FEeUMseUJBR3pDLEdBQUksQ0FBQ0gsaUJBQUwsQ0FBd0IsMkRBQU9iLENBQUFBLEdBQUcsQ0FBQ2MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCLENBQUVDLE9BQU8sQ0FBRSxxQ0FBWCxDQUFyQixDQUFQLENBQWdGLENBQXhHLGlDQUh5Qyx5QkFLekMsTUFBT2hCLENBQUFBLEdBQUcsQ0FBQ2MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCLENBQUVaLFdBQVcsQ0FBRVUsaUJBQWYsQ0FBckIsQ0FBUCxDQUNILENBTkQsRUFRSCxDQUVELFFBQVNJLENBQUFBLHNCQUFULENBQWdDbEIsR0FBaEMsQ0FBcUNDLEdBQXJDLENBQTBDLHlCQUV0QyxHQUFJa0IsQ0FBQUEsSUFBSSwyQkFBRyxDQUFILENBQVIsQ0FGc0MseUJBR3RDLEdBQUluQixHQUFHLENBQUNFLE1BQUosQ0FBV2lCLElBQWYsQ0FBcUIscURBQ2pCQSxJQUFJLENBQUduQixHQUFHLENBQUNFLE1BQUosQ0FBV2lCLElBQWxCLENBQ0gsQ0FGRCxpQ0FHQSxHQUFJQyxDQUFBQSxZQUFZLDJCQUFHLENBQUgsQ0FBaEIsQ0FOc0MseUJBU3RDdkIsTUFBTSxDQUFDd0IsSUFBUCxDQUFZLENBQUVaLElBQUksQ0FBRVQsR0FBRyxDQUFDUyxJQUFKLENBQVNDLEdBQWpCLENBQVosRUFBb0NZLFFBQXBDLENBQTZDLFVBQTdDLEVBQXlEQyxJQUF6RCxDQUE4RCxDQUFDVixHQUFELENBQU1XLE9BQU4sR0FBa0Isa0RBQzVFLEdBQUlYLEdBQUosQ0FBUywyREFBT1osQ0FBQUEsR0FBRyxDQUFDYyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUIsQ0FBRUMsT0FBTyxDQUFFLHVCQUFYLENBQXJCLENBQVAsQ0FBa0UsQ0FBM0UsaUNBRUEsR0FBSVEsQ0FBQUEsYUFBYSwyQkFBRyxFQUFILENBQWpCLENBSDRFLHlCQUs1RUQsT0FBTyxDQUFDRSxPQUFSLENBQWlCQyxNQUFELEVBQVksa0RBQ3hCRixhQUFhLENBQUNHLElBQWQsQ0FBbUJELE1BQU0sQ0FBQ0UsUUFBMUIsRUFDSCxDQUZELEVBTDRFLHlCQVM1RUosYUFBYSxDQUFDRyxJQUFkLENBQW1CNUIsR0FBRyxDQUFDUyxJQUFKLENBQVNDLEdBQTVCLEVBVDRFLHlCQVc1RWYsV0FBVyxDQUFDMEIsSUFBWixDQUFpQixDQUFFWixJQUFJLENBQUUsQ0FBRSxNQUFPZ0IsYUFBVCxDQUFSLENBQWpCLEVBQXFESyxJQUFyRCxDQUEwRCxhQUExRCxFQUF5RVIsUUFBekUsQ0FBa0YsZ0JBQWxGLEVBQW9HQSxRQUFwRyxDQUE2RyxDQUFFN0IsSUFBSSxDQUFFLE1BQVIsQ0FBZ0I2QixRQUFRLENBQUUsQ0FBRTdCLElBQUksQ0FBRSxRQUFSLENBQTFCLENBQTdHLEVBQTZKc0MsUUFBN0osQ0FBc0taLElBQXRLLENBQTRLQyxZQUE1SyxDQUEwTCxDQUFDUCxHQUFELENBQU1tQixZQUFOLENBQW9CQyxLQUFwQixHQUE4QixrREFDcE4sR0FBSXBCLEdBQUosQ0FBUywyREFBT1osQ0FBQUEsR0FBRyxDQUFDYyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUIsQ0FBRUMsT0FBTyxDQUFFLHVCQUFYLENBQXJCLENBQVAsQ0FBa0UsQ0FBM0UsaUNBRG9OLHlCQUdwTixHQUFJLENBQUNlLFlBQUwsQ0FBbUIsMkRBQU8vQixDQUFBQSxHQUFHLENBQUNjLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQixDQUFFQyxPQUFPLENBQUUsdUJBQVgsQ0FBckIsQ0FBUCxDQUFrRSxDQUFyRixpQ0FIb04seUJBS3BOLE1BQU9oQixDQUFBQSxHQUFHLENBQUNjLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQixDQUN4QmlCLEtBQUssQ0FBRUEsS0FEaUIsQ0FFeEJDLEtBQUssQ0FBRUMsSUFBSSxDQUFDQyxJQUFMLENBQVVILEtBQUssQ0FBR2IsWUFBbEIsQ0FGaUIsQ0FHeEJELElBQUksQ0FBRUEsSUFIa0IsQ0FJeEJhLFlBQVksQ0FBRUEsWUFKVSxDQUFyQixDQUFQLENBTUgsQ0FYRCxFQWFILENBeEJELEVBMkJILENBRUQsUUFBU0ssQ0FBQUEsbUJBQVQsQ0FBNkJyQyxHQUE3QixDQUFrQ0MsR0FBbEMsQ0FBdUMseUJBRW5DLEdBQUlrQixDQUFBQSxJQUFJLDJCQUFHLENBQUgsQ0FBUixDQUZtQyx5QkFHbkMsR0FBSW5CLEdBQUcsQ0FBQ0UsTUFBSixDQUFXaUIsSUFBZixDQUFxQixxREFDakJBLElBQUksQ0FBR25CLEdBQUcsQ0FBQ0UsTUFBSixDQUFXaUIsSUFBbEIsQ0FDSCxDQUZELGlDQUdBLEdBQUlDLENBQUFBLFlBQVksMkJBQUcsQ0FBSCxDQUFoQixDQUVBLEdBQUlrQixDQUFBQSxPQUFPLDJCQUFHdEMsR0FBRyxDQUFDUyxJQUFKLENBQVNDLEdBQVosQ0FBWCxDQVJtQyx5QkFTbkMsR0FBSVYsR0FBRyxDQUFDRSxNQUFKLENBQVdPLElBQWYsQ0FBcUIsc0RBQ2pCNkIsT0FBTyxDQUFHdEMsR0FBRyxDQUFDRSxNQUFKLENBQVdPLElBQXJCLENBQ0gsQ0FGRCxrQ0FUbUMseUJBYW5DZCxXQUFXLENBQUMwQixJQUFaLENBQWlCLENBQUVaLElBQUksQ0FBRTZCLE9BQVIsQ0FBakIsRUFBb0NSLElBQXBDLENBQXlDLGFBQXpDLEVBQXdEUixRQUF4RCxDQUFpRSxnQkFBakUsRUFBbUZBLFFBQW5GLENBQTRGLENBQUU3QixJQUFJLENBQUUsTUFBUixDQUFnQjZCLFFBQVEsQ0FBRSxDQUFFN0IsSUFBSSxDQUFFLFFBQVIsQ0FBMUIsQ0FBNUYsRUFBNElzQyxRQUE1SSxDQUFxSlosSUFBckosQ0FBMkpDLFlBQTNKLENBQXlLLENBQUNQLEdBQUQsQ0FBTW1CLFlBQU4sQ0FBb0JDLEtBQXBCLEdBQThCLGtEQUNuTSxHQUFJcEIsR0FBSixDQUFTLDREQUFPWixDQUFBQSxHQUFHLENBQUNjLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQixDQUFFQyxPQUFPLENBQUUsdUJBQVgsQ0FBckIsQ0FBUCxDQUFrRSxDQUEzRSxrQ0FEbU0seUJBR25NLEdBQUksQ0FBQ2UsWUFBTCxDQUFtQiw0REFBTy9CLENBQUFBLEdBQUcsQ0FBQ2MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCLENBQUVDLE9BQU8sQ0FBRSx1QkFBWCxDQUFyQixDQUFQLENBQWtFLENBQXJGLGtDQUhtTSx5QkFLbk0sTUFBT2hCLENBQUFBLEdBQUcsQ0FBQ2MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCLENBQ3hCaUIsS0FBSyxDQUFFQSxLQURpQixDQUV4QkMsS0FBSyxDQUFFQyxJQUFJLENBQUNDLElBQUwsQ0FBVUgsS0FBSyxDQUFHYixZQUFsQixDQUZpQixDQUd4QkQsSUFBSSxDQUFFQSxJQUhrQixDQUl4QmEsWUFBWSxDQUFFQSxZQUpVLENBQXJCLENBQVAsQ0FNSCxDQVhELEVBYUgsQ0FJRCxRQUFTTyxDQUFBQSxjQUFULENBQXdCdkMsR0FBeEIsQ0FBNkJDLEdBQTdCLENBQWtDLHlCQUM5QixHQUFJdUMsQ0FBQUEsYUFBYSwyQkFBR3hDLEdBQUcsQ0FBQ0UsTUFBSixDQUFXdUMsRUFBZCxDQUFqQixDQUQ4Qix5QkFHOUI5QyxXQUFXLENBQUMrQyxRQUFaLENBQXFCRixhQUFyQixDQUFvQyxDQUFDM0IsR0FBRCxDQUFNVCxXQUFOLEdBQXNCLGtEQUN0RCxHQUFJUyxHQUFKLENBQVMsNERBQU9aLENBQUFBLEdBQUcsQ0FBQ2MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCLENBQUVDLE9BQU8sQ0FBRSxpQkFBWCxDQUFyQixDQUFQLENBQTRELENBQXJFLGtDQURzRCx5QkFHdEQsR0FBSSxDQUFDYixXQUFMLENBQWtCLDREQUFPSCxDQUFBQSxHQUFHLENBQUNjLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQixDQUFFQyxPQUFPLENBQUUsMkJBQVgsQ0FBckIsQ0FBUCxDQUFzRSxDQUF4RixrQ0FIc0QseUJBS3RELE1BQU9oQixDQUFBQSxHQUFHLENBQUNjLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQixDQUFFWixXQUFGLENBQXJCLENBQVAsQ0FHSCxDQVJELEVBU0gsQ0FFRCxRQUFTdUMsQ0FBQUEsaUJBQVQsQ0FBMkIzQyxHQUEzQixDQUFnQ0MsR0FBaEMsQ0FBcUMsMEJBQ2pDLEdBQUl1QyxDQUFBQSxhQUFhLDJCQUFHeEMsR0FBRyxDQUFDRSxNQUFKLENBQVd1QyxFQUFkLENBQWpCLENBRGlDLHlCQUdqQzlDLFdBQVcsQ0FBQzBCLElBQVosQ0FBaUIsQ0FBRSxPQUFRckIsR0FBRyxDQUFDUyxJQUFKLENBQVNDLEdBQW5CLENBQXdCLE1BQU84QixhQUEvQixDQUFqQixFQUFpRUksTUFBakUsQ0FBd0UvQixHQUFHLEVBQUksbURBQzNFLEdBQUlBLEdBQUosQ0FBUyw0REFBT1osQ0FBQUEsR0FBRyxDQUFDYyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUIsQ0FBRUMsT0FBTyxDQUFFLGlCQUFYLENBQXJCLENBQVAsQ0FBNEQsQ0FBckUsa0NBQ0E7QUFGMkUseUJBSTNFLE1BQU9oQixDQUFBQSxHQUFHLENBQUNjLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQixDQUFFQyxPQUFPLENBQUUsdUJBQVgsQ0FBckIsQ0FBUCxDQUVILENBTkQsRUFPSCxDQUVELFFBQVM0QixDQUFBQSxXQUFULENBQXFCN0MsR0FBckIsQ0FBMEJDLEdBQTFCLENBQStCLDBCQUMzQixHQUFJdUMsQ0FBQUEsYUFBYSwyQkFBR3hDLEdBQUcsQ0FBQ0UsTUFBSixDQUFXdUMsRUFBZCxDQUFqQixDQUQyQix5QkFHM0IsR0FBSXpDLEdBQUcsQ0FBQzhDLEtBQVIsQ0FBZSw2QkFDWCxHQUFJQyxDQUFBQSxTQUFTLDJCQUFHL0MsR0FBRyxDQUFDOEMsS0FBSixDQUFVRSxLQUFWLENBQWdCdkQsSUFBbkIsQ0FBYixDQUNBLEdBQUl3RCxDQUFBQSxVQUFVLDJCQUFHRixTQUFTLENBQUNHLEtBQVYsQ0FBZ0IsSUFBaEIsQ0FBSCxDQUFkLENBRUEsR0FBSUMsQ0FBQUEsU0FBUywyQkFBR0YsVUFBVSxDQUFDLENBQUQsQ0FBYixDQUFiLENBRUEsR0FBSUcsQ0FBQUEsUUFBUSwyQkFBR0QsU0FBUyxDQUFDRCxLQUFWLENBQWdCLElBQWhCLENBQUgsQ0FBWixDQUNBLEdBQUlHLENBQUFBLFFBQVEsMkJBQUdELFFBQVEsQ0FBQyxDQUFELENBQVgsQ0FBWixDQVBXLHlCQVVYLEdBQUksNkJBQUFDLFFBQVEsRUFBSSxLQUFaLGdDQUFxQkEsUUFBUSxFQUFJLEtBQWpDLENBQUosQ0FBNEMsc0RBRXhDMUQsV0FBVyxDQUFDMkQsT0FBWixDQUFvQixDQUFFLE9BQVF0RCxHQUFHLENBQUNTLElBQUosQ0FBU0MsR0FBbkIsQ0FBd0IsTUFBTzhCLGFBQS9CLENBQXBCLEVBQW9FakIsSUFBcEUsQ0FBeUUsQ0FBQ1YsR0FBRCxDQUFNVCxXQUFOLEdBQXNCLG1EQUUzRixHQUFJQSxXQUFKLENBQWlCLHNEQUNiVCxXQUFXLENBQUM0RCxpQkFBWixDQUE4QmYsYUFBOUIsQ0FBNkMsQ0FBRWxDLElBQUksQ0FBRTZDLFNBQVIsQ0FBN0MsQ0FBa0UsQ0FBRUssR0FBRyxDQUFFLElBQVAsQ0FBbEUsQ0FBaUYsQ0FBQzNDLEdBQUQsQ0FBTTRDLGtCQUFOLEdBQTZCLG1EQUMxRyxHQUFJNUMsR0FBSixDQUFTLDREQUFPWixDQUFBQSxHQUFHLENBQUNjLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQixDQUFFQyxPQUFPLENBQUUsdUJBQVgsQ0FBckIsQ0FBUCxDQUFrRSxDQUEzRSxrQ0FEMEcseUJBRzFHLEdBQUksQ0FBQ3dDLGtCQUFMLENBQXlCLDREQUFPeEQsQ0FBQUEsR0FBRyxDQUFDYyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUIsQ0FBRUMsT0FBTyxDQUFFLGdEQUFYLENBQXJCLENBQVAsQ0FBMkYsQ0FBcEgsa0NBSDBHLHlCQUsxRyxNQUFPaEIsQ0FBQUEsR0FBRyxDQUFDYyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUIsQ0FBRVAsSUFBSSxDQUFFZ0Qsa0JBQVIsQ0FBckIsQ0FBUCxDQUNILENBTkQsRUFRSCxDQVRELElBU08sc0RBQ0gsTUFBT0MsQ0FBQUEsb0JBQW9CLENBQUN6RCxHQUFELENBQU04QyxTQUFOLENBQWlCLHFCQUFqQixDQUEzQixDQUVILENBQ0osQ0FmRCxFQW1CSCxDQXJCRCxJQXFCTyxzREFDSCxNQUFPVyxDQUFBQSxvQkFBb0IsQ0FBQ3pELEdBQUQsQ0FBTThDLFNBQU4sQ0FBaUIsc0JBQWpCLENBQTNCLENBQ0gsQ0FDSixDQWxDRCxJQWtDTyxzREFDSCxNQUFPOUMsQ0FBQUEsR0FBRyxDQUFDYyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUIsQ0FBRUMsT0FBTyxDQUFFLDRCQUFYLENBQXJCLENBQVAsQ0FDSCxDQUNKLENBRUQsUUFBU3lDLENBQUFBLG9CQUFULENBQThCekQsR0FBOUIsQ0FBbUM4QyxTQUFuQyxDQUE4QzlCLE9BQTlDLENBQXVELG1EQUNuRHpCLEVBQUUsQ0FBQ21FLE1BQUgsQ0FBVVosU0FBVixDQUFzQmxDLEdBQUQsRUFBUyxtREFDMUIsR0FBSUEsR0FBSixDQUFTLDREQUFPWixDQUFBQSxHQUFHLENBQUNjLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQixDQUFFQyxPQUFPLENBQUVBLE9BQVgsQ0FBckIsQ0FBUCxDQUFrRCxDQUEzRCxrQ0FFSCxDQUhELEVBSUgsQ0FFRCxRQUFTMkMsQ0FBQUEsWUFBVCxDQUFzQjVELEdBQXRCLENBQTJCQyxHQUEzQixDQUFnQywwQkFDNUIsR0FBSTRELENBQUFBLFNBQVMsMkJBQUc3RCxHQUFHLENBQUNFLE1BQUosQ0FBVzJELFNBQWQsQ0FBYixDQUNBLEdBQUlDLENBQUFBLFNBQVMsMkJBQUcsMEJBQTRCRCxTQUEvQixDQUFiLENBRjRCLHlCQUk1QnJFLEVBQUUsQ0FBQ3VFLE1BQUgsQ0FBVUQsU0FBVixDQUFzQkUsS0FBRCxFQUFXLG1EQUM1QixHQUFJQSxLQUFKLENBQVcsc0RBQ1AvRCxHQUFHLENBQUNnRSxRQUFKLENBQWF4RSxJQUFJLENBQUN5RSxPQUFMLENBQWFKLFNBQWIsQ0FBYixFQUNILENBRkQsSUFFTyxzREFDSCxNQUFPN0QsQ0FBQUEsR0FBRyxDQUFDYyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUIsQ0FBRUMsT0FBTyxDQUFFLG1CQUFYLENBQXJCLENBQVAsQ0FFSCxDQUNKLENBUEQsRUFRSCxDQUVELFFBQVNrRCxDQUFBQSwwQkFBVCxDQUFvQ25FLEdBQXBDLENBQXlDQyxHQUF6QyxDQUE4QyxtREFFMUNOLFdBQVcsQ0FDTnlFLFNBREwsQ0FDZSxDQUFDLENBQ1JDLE1BQU0sQ0FBRSxDQUNKLE9BQVEsQ0FDSixVQUFXLElBRFAsQ0FFSixNQUFPLElBRkgsQ0FESixDQURBLENBQUQsQ0FPUixDQUFFQyxNQUFNLENBQUUsQ0FBRUMsR0FBRyxDQUFFLE9BQVAsQ0FBZ0JDLEtBQUssQ0FBRSxDQUFFQyxJQUFJLENBQUUsQ0FBUixDQUF2QixDQUFWLENBUFEsQ0FEZixFQVEwRDNDLElBUjFELENBUStELENBQUUwQyxLQUFLLENBQUUsQ0FBQyxDQUFWLENBUi9ELEVBUThFRSxLQVI5RSxDQVFvRixDQVJwRixFQVF1Rm5ELElBUnZGLENBUTRGLENBQUNWLEdBQUQsQ0FBTThELEtBQU4sR0FBZ0IsbURBQ3BHLEdBQUk5RCxHQUFKLENBQVMsNERBQU9aLENBQUFBLEdBQUcsQ0FBQ2MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCLENBQUVDLE9BQU8sQ0FBRSx1QkFBWCxDQUFyQixDQUFQLENBQWtFLENBQTNFLGtDQURvRywwQkFHcEcsR0FBSSxDQUFDMEQsS0FBTCxDQUFZLDZEQUFPMUUsQ0FBQUEsR0FBRyxDQUFDYyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUIsQ0FBRUMsT0FBTyxDQUFFLCtCQUFYLENBQXJCLENBQVAsQ0FBMEUsQ0FBdEYsa0NBSG9HLDBCQU1wR25CLElBQUksQ0FBQ3dCLFFBQUwsQ0FBY3FELEtBQWQsQ0FBcUIsQ0FBRWxGLElBQUksQ0FBRSxLQUFSLENBQXJCLENBQXNDLENBQUNvQixHQUFELENBQU04RCxLQUFOLEdBQWdCLG9EQUNsRCxHQUFJOUQsR0FBSixDQUFTLDZEQUFPWixDQUFBQSxHQUFHLENBQUNjLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQixDQUFFQyxPQUFPLENBQUUsdUJBQVgsQ0FBckIsQ0FBUCxDQUFrRSxDQUEzRSxrQ0FEa0QsMEJBR2xELEdBQUksQ0FBQzBELEtBQUwsQ0FBWSw2REFBTzFFLENBQUFBLEdBQUcsQ0FBQ2MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCLENBQUVDLE9BQU8sQ0FBRSwrQkFBWCxDQUFyQixDQUFQLENBQTBFLENBQXRGLGtDQUhrRCwwQkFLbEQsTUFBT2hCLENBQUFBLEdBQUcsQ0FBQ2MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCLENBQUUyRCxLQUFGLENBQXJCLENBQVAsQ0FJSCxDQVRELEVBY0gsQ0E1QkwsRUE2QkgsQywwQkFFREMsTUFBTSxDQUFDQyxPQUFQLENBQWlCLENBRWI5RSxlQUZhLENBR2JtQixzQkFIYSxDQUlicUIsY0FKYSxDQUtiSSxpQkFMYSxDQU1iRSxXQU5hLENBT2JlLFlBUGEsQ0FRYnZCLG1CQVJhLENBU2I4QiwwQkFUYSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xyXG5cclxudmFyIG1vbmdvb3NlUGFnaW5hdGlvbiA9IHJlcXVpcmUoJ21vbmdvb3NlLXBhZ2luYXRpb24nKTtcclxudmFyIGZzID0gcmVxdWlyZSgnZnMnKTtcclxudmFyIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcbnZhciBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKTtcclxuXHJcbnZhciBQdWJsaWNhdGlvbiA9IHJlcXVpcmUoJy4uL21vZGVscy9wdWJsaWNhdGlvbicpO1xyXG52YXIgVXNlciA9IHJlcXVpcmUoJy4uL21vZGVscy91c2VyJyk7XHJcbnZhciBGb2xsb3cgPSByZXF1aXJlKCcuLi9tb2RlbHMvZm9sbG93Jyk7XHJcbnZhciBTb25nID0gcmVxdWlyZSgnLi4vbW9kZWxzL3NvbmcnKTtcclxuXHJcblxyXG5cclxuXHJcbmZ1bmN0aW9uIHNhdmVQdWJsaWNhdGlvbihyZXEsIHJlcykge1xyXG4gICAgdmFyIHBhcmFtcyA9IHJlcS5ib2R5O1xyXG5cclxuICAgIHZhciBwdWJsaWNhdGlvbiA9IG5ldyBQdWJsaWNhdGlvbigpO1xyXG5cclxuICAgIGlmICghcGFyYW1zLnRleHQpIHtcclxuICAgICAgICBwdWJsaWNhdGlvbi50ZXh0ID0gXCJSZWNvbWllbmRvIGVzdGEgY2FuY2nDs24gYSBtaXMgc2VndWlkb3JlcyEhIVwiXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHB1YmxpY2F0aW9uLnRleHQgPSBwYXJhbXMudGV4dDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXBhcmFtcy5maWxlKSB7XHJcbiAgICAgICAgcHVibGljYXRpb24uZmlsZSA9IG51bGw7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHB1YmxpY2F0aW9uLmZpbGUgPSBwYXJhbXMuZmlsZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWNhdGlvbi5jcmVhdGVkX2F0ID0gbW9tZW50KCkudW5peCgpO1xyXG5cclxuICAgIHB1YmxpY2F0aW9uLnVzZXIgPSByZXEudXNlci5zdWI7XHJcblxyXG4gICAgaWYgKCFwYXJhbXMuc29uZykge1xyXG4gICAgICAgIHB1YmxpY2F0aW9uLnNvbmcgPSBudWxsO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBwdWJsaWNhdGlvbi5zb25nID0gcGFyYW1zLnNvbmc7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHB1YmxpY2F0aW9uLnNhdmUoKGVyciwgcHVibGljYXRpb25TdG9yZWQpID0+IHtcclxuICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVzLnN0YXR1cyg1MDApLnNlbmQoeyBtZXNzYWdlOiAnRXJyb3IgZW4gbGEgcGV0aWNpw7NuLicgfSk7XHJcblxyXG4gICAgICAgIGlmICghcHVibGljYXRpb25TdG9yZWQpIHJldHVybiByZXMuc3RhdHVzKDQwNCkuc2VuZCh7IG1lc3NhZ2U6ICdMYSBwdWJsaWNhY2nDs24gTk8gaGEgc2lkbyBndWFyZGFkYS4nIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLnNlbmQoeyBwdWJsaWNhdGlvbjogcHVibGljYXRpb25TdG9yZWQgfSk7XHJcbiAgICB9KTtcclxuXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFB1YmxpY2F0aW9uVGltZWxpbmUocmVxLCByZXMpIHtcclxuXHJcbiAgICB2YXIgcGFnZSA9IDE7XHJcbiAgICBpZiAocmVxLnBhcmFtcy5wYWdlKSB7XHJcbiAgICAgICAgcGFnZSA9IHJlcS5wYXJhbXMucGFnZTtcclxuICAgIH1cclxuICAgIHZhciBpdGVtc1BlclBhZ2UgPSA1O1xyXG5cclxuXHJcbiAgICBGb2xsb3cuZmluZCh7IHVzZXI6IHJlcS51c2VyLnN1YiB9KS5wb3B1bGF0ZSgnZm9sbG93ZWQnKS5leGVjKChlcnIsIGZvbGxvd3MpID0+IHtcclxuICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVzLnN0YXR1cyg1MDApLnNlbmQoeyBtZXNzYWdlOiAnRXJyb3IgZW4gbGEgcGV0aWNpw7NuLicgfSk7XHJcblxyXG4gICAgICAgIHZhciBmb2xsb3dzX2NsZWFuID0gW107XHJcblxyXG4gICAgICAgIGZvbGxvd3MuZm9yRWFjaCgoZm9sbG93KSA9PiB7XHJcbiAgICAgICAgICAgIGZvbGxvd3NfY2xlYW4ucHVzaChmb2xsb3cuZm9sbG93ZWQpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBmb2xsb3dzX2NsZWFuLnB1c2gocmVxLnVzZXIuc3ViKTtcclxuXHJcbiAgICAgICAgUHVibGljYXRpb24uZmluZCh7IHVzZXI6IHsgXCIkaW5cIjogZm9sbG93c19jbGVhbiB9IH0pLnNvcnQoJy1jcmVhdGVkX2F0JykucG9wdWxhdGUoJ3VzZXIgc29uZyBmaWxlJykucG9wdWxhdGUoeyBwYXRoOiAnc29uZycsIHBvcHVsYXRlOiB7IHBhdGg6ICdhcnRpc3QnIH0gfSkucGFnaW5hdGUocGFnZSwgaXRlbXNQZXJQYWdlLCAoZXJyLCBwdWJsaWNhdGlvbnMsIHRvdGFsKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHJldHVybiByZXMuc3RhdHVzKDUwMCkuc2VuZCh7IG1lc3NhZ2U6ICdFcnJvciBlbiBsYSBwZXRpY2nDs24uJyB9KTtcclxuXHJcbiAgICAgICAgICAgIGlmICghcHVibGljYXRpb25zKSByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLnNlbmQoeyBtZXNzYWdlOiAnTm8gaGF5IHB1YmxpY2FjaW9uZXMuJyB9KTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuc2VuZCh7XHJcbiAgICAgICAgICAgICAgICB0b3RhbDogdG90YWwsXHJcbiAgICAgICAgICAgICAgICBwYWdlczogTWF0aC5jZWlsKHRvdGFsIC8gaXRlbXNQZXJQYWdlKSxcclxuICAgICAgICAgICAgICAgIHBhZ2U6IHBhZ2UsXHJcbiAgICAgICAgICAgICAgICBwdWJsaWNhdGlvbnM6IHB1YmxpY2F0aW9uc1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgfSlcclxuXHJcblxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRQdWJsaWNhdGlvbnNVc2VyKHJlcSwgcmVzKSB7XHJcblxyXG4gICAgdmFyIHBhZ2UgPSAxO1xyXG4gICAgaWYgKHJlcS5wYXJhbXMucGFnZSkge1xyXG4gICAgICAgIHBhZ2UgPSByZXEucGFyYW1zLnBhZ2U7XHJcbiAgICB9XHJcbiAgICB2YXIgaXRlbXNQZXJQYWdlID0gNTtcclxuXHJcbiAgICB2YXIgdXNlcl9pZCA9IHJlcS51c2VyLnN1YjtcclxuICAgIGlmIChyZXEucGFyYW1zLnVzZXIpIHtcclxuICAgICAgICB1c2VyX2lkID0gcmVxLnBhcmFtcy51c2VyO1xyXG4gICAgfVxyXG5cclxuICAgIFB1YmxpY2F0aW9uLmZpbmQoeyB1c2VyOiB1c2VyX2lkIH0pLnNvcnQoJy1jcmVhdGVkX2F0JykucG9wdWxhdGUoJ3VzZXIgc29uZyBmaWxlJykucG9wdWxhdGUoeyBwYXRoOiAnc29uZycsIHBvcHVsYXRlOiB7IHBhdGg6ICdhcnRpc3QnIH0gfSkucGFnaW5hdGUocGFnZSwgaXRlbXNQZXJQYWdlLCAoZXJyLCBwdWJsaWNhdGlvbnMsIHRvdGFsKSA9PiB7XHJcbiAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5zZW5kKHsgbWVzc2FnZTogJ0Vycm9yIGVuIGxhIHBldGljacOzbi4nIH0pO1xyXG5cclxuICAgICAgICBpZiAoIXB1YmxpY2F0aW9ucykgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5zZW5kKHsgbWVzc2FnZTogJ05vIGhheSBwdWJsaWNhY2lvbmVzLicgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuc2VuZCh7XHJcbiAgICAgICAgICAgIHRvdGFsOiB0b3RhbCxcclxuICAgICAgICAgICAgcGFnZXM6IE1hdGguY2VpbCh0b3RhbCAvIGl0ZW1zUGVyUGFnZSksXHJcbiAgICAgICAgICAgIHBhZ2U6IHBhZ2UsXHJcbiAgICAgICAgICAgIHB1YmxpY2F0aW9uczogcHVibGljYXRpb25zXHJcbiAgICAgICAgfSlcclxuICAgIH0pXHJcblxyXG59XHJcblxyXG5cclxuXHJcbmZ1bmN0aW9uIGdldFB1YmxpY2F0aW9uKHJlcSwgcmVzKSB7XHJcbiAgICB2YXIgcHVibGljYXRpb25JZCA9IHJlcS5wYXJhbXMuaWQ7XHJcblxyXG4gICAgUHVibGljYXRpb24uZmluZEJ5SWQocHVibGljYXRpb25JZCwgKGVyciwgcHVibGljYXRpb24pID0+IHtcclxuICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVzLnN0YXR1cyg1MDApLnNlbmQoeyBtZXNzYWdlOiAnRXJyb3IgcGV0aWNpw7NuLicgfSk7XHJcblxyXG4gICAgICAgIGlmICghcHVibGljYXRpb24pIHJldHVybiByZXMuc3RhdHVzKDQwNCkuc2VuZCh7IG1lc3NhZ2U6ICdMYSBwdWJsaWNhY2nDs24gbm8gZXhpc3RlLicgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuc2VuZCh7IHB1YmxpY2F0aW9uIH0pO1xyXG5cclxuXHJcbiAgICB9KVxyXG59XHJcblxyXG5mdW5jdGlvbiBkZWxldGVQdWJsaWNhdGlvbihyZXEsIHJlcykge1xyXG4gICAgdmFyIHB1YmxpY2F0aW9uSWQgPSByZXEucGFyYW1zLmlkO1xyXG5cclxuICAgIFB1YmxpY2F0aW9uLmZpbmQoeyAndXNlcic6IHJlcS51c2VyLnN1YiwgJ19pZCc6IHB1YmxpY2F0aW9uSWQgfSkucmVtb3ZlKGVyciA9PiB7XHJcbiAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5zZW5kKHsgbWVzc2FnZTogJ0Vycm9yIHBldGljacOzbi4nIH0pO1xyXG4gICAgICAgIC8vaWYgKCFwdWJsaWNhdGlvblJlbW92ZWQpIHJldHVybiByZXMuc3RhdHVzKDQwNCkuc2VuZCh7IG1lc3NhZ2U6ICdMYSBwdWJsaWNhY2nDs24gbm8gc2UgaGEgZWxpbWluYWRvLicgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuc2VuZCh7IG1lc3NhZ2U6ICdQdWJsaWNhacOzbiBlbGltaW5hZGEuJyB9KTtcclxuXHJcbiAgICB9KVxyXG59XHJcblxyXG5mdW5jdGlvbiB1cGxvYWRJbWFnZShyZXEsIHJlcykge1xyXG4gICAgdmFyIHB1YmxpY2F0aW9uSWQgPSByZXEucGFyYW1zLmlkO1xyXG5cclxuICAgIGlmIChyZXEuZmlsZXMpIHtcclxuICAgICAgICB2YXIgZmlsZV9wYXRoID0gcmVxLmZpbGVzLmltYWdlLnBhdGg7XHJcbiAgICAgICAgdmFyIGZpbGVfc3BsaXQgPSBmaWxlX3BhdGguc3BsaXQoJ1xcXFwnKTtcclxuXHJcbiAgICAgICAgdmFyIGZpbGVfbmFtZSA9IGZpbGVfc3BsaXRbMl07XHJcblxyXG4gICAgICAgIHZhciBleHRfZmlsZSA9IGZpbGVfbmFtZS5zcGxpdCgnXFwuJyk7XHJcbiAgICAgICAgdmFyIGZpbGVfZXh0ID0gZXh0X2ZpbGVbMV07XHJcblxyXG5cclxuICAgICAgICBpZiAoZmlsZV9leHQgPT0gJ3BuZycgfHwgZmlsZV9leHQgPT0gJ2pwZycpIHtcclxuXHJcbiAgICAgICAgICAgIFB1YmxpY2F0aW9uLmZpbmRPbmUoeyAndXNlcic6IHJlcS51c2VyLnN1YiwgJ19pZCc6IHB1YmxpY2F0aW9uSWQgfSkuZXhlYygoZXJyLCBwdWJsaWNhdGlvbikgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChwdWJsaWNhdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIFB1YmxpY2F0aW9uLmZpbmRCeUlkQW5kVXBkYXRlKHB1YmxpY2F0aW9uSWQsIHsgZmlsZTogZmlsZV9uYW1lIH0sIHsgbmV3OiB0cnVlIH0sIChlcnIsIHB1YmxpY2F0aW9uVXBkYXRlZCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVzLnN0YXR1cyg1MDApLnNlbmQoeyBtZXNzYWdlOiAnRXJyb3IgZW4gbGEgcGV0aWNpw7NuLicgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXB1YmxpY2F0aW9uVXBkYXRlZCkgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5zZW5kKHsgbWVzc2FnZTogJ05vIHNlIGhhIHBvZGlkbyBhY3R1YWxpemFyIGltYWdlbiBkZWwgdXN1YXJpby4nIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5zZW5kKHsgdXNlcjogcHVibGljYXRpb25VcGRhdGVkIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlbW92ZUZpbGVzT2ZVcGxvYWRzKHJlcywgZmlsZV9wYXRoLCAnTm8gdGllbmVzIHBlcm1pc29zLicpO1xyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuXHJcblxyXG5cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVtb3ZlRmlsZXNPZlVwbG9hZHMocmVzLCBmaWxlX3BhdGgsICdFeHRlbnNpw7NuIG5vIHbDoWxpZGEuJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLnNlbmQoeyBtZXNzYWdlOiAnTm8gc2UgaGFuIHN1YmlkbyBpbcOhZ2VuZXMuJyB9KTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcmVtb3ZlRmlsZXNPZlVwbG9hZHMocmVzLCBmaWxlX3BhdGgsIG1lc3NhZ2UpIHtcclxuICAgIGZzLnVubGluayhmaWxlX3BhdGgsIChlcnIpID0+IHtcclxuICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVzLnN0YXR1cyg1MDApLnNlbmQoeyBtZXNzYWdlOiBtZXNzYWdlIH0pO1xyXG5cclxuICAgIH0pXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldEltYWdlRmlsZShyZXEsIHJlcykge1xyXG4gICAgdmFyIGltYWdlRmlsZSA9IHJlcS5wYXJhbXMuaW1hZ2VGaWxlO1xyXG4gICAgdmFyIHBhdGhfZmlsZSA9ICcuL3VwbG9hZHMvcHVibGljYXRpb25zLycgKyBpbWFnZUZpbGU7XHJcblxyXG4gICAgZnMuZXhpc3RzKHBhdGhfZmlsZSwgKGV4aXRzKSA9PiB7XHJcbiAgICAgICAgaWYgKGV4aXRzKSB7XHJcbiAgICAgICAgICAgIHJlcy5zZW5kRmlsZShwYXRoLnJlc29sdmUocGF0aF9maWxlKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5zZW5kKHsgbWVzc2FnZTogJ05vIGV4aXN0ZSBpbWFnZW4uJyB9KTtcclxuXHJcbiAgICAgICAgfVxyXG4gICAgfSlcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0VG9wM0NhbmNpb25lc1B1YmxpY2FkYXMocmVxLCByZXMpIHtcclxuXHJcbiAgICBQdWJsaWNhdGlvblxyXG4gICAgICAgIC5hZ2dyZWdhdGUoW3tcclxuICAgICAgICAgICAgJG1hdGNoOiB7XHJcbiAgICAgICAgICAgICAgICBcInNvbmdcIjoge1xyXG4gICAgICAgICAgICAgICAgICAgIFwiJGV4aXN0c1wiOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgIFwiJG5lXCI6IG51bGxcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sIHsgJGdyb3VwOiB7IF9pZDogXCIkc29uZ1wiLCBjb3VudDogeyAkc3VtOiAxIH0gfSB9XSkuc29ydCh7IGNvdW50OiAtMSB9KS5saW1pdCgzKS5leGVjKChlcnIsIHNvbmdzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHJldHVybiByZXMuc3RhdHVzKDUwMCkuc2VuZCh7IG1lc3NhZ2U6ICdFcnJvciBlbiBsYSBwZXRpY2nDs24uJyB9KTtcclxuXHJcbiAgICAgICAgICAgIGlmICghc29uZ3MpIHJldHVybiByZXMuc3RhdHVzKDQwNCkuc2VuZCh7IG1lc3NhZ2U6ICdObyBoYXkgY2FuY2lvbmVzIGRpc3BvbmlibGVzLicgfSk7XHJcblxyXG5cclxuICAgICAgICAgICAgU29uZy5wb3B1bGF0ZShzb25ncywgeyBwYXRoOiAnX2lkJyB9LCAoZXJyLCBzb25ncykgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5zZW5kKHsgbWVzc2FnZTogJ0Vycm9yIGVuIGxhIHBldGljacOzbi4nIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghc29uZ3MpIHJldHVybiByZXMuc3RhdHVzKDQwNCkuc2VuZCh7IG1lc3NhZ2U6ICdObyBoYXkgY2FuY2lvbmVzIGRpc3BvbmlibGVzLicgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5zZW5kKHsgc29uZ3MgfSk7XHJcblxyXG5cclxuXHJcbiAgICAgICAgICAgIH0pXHJcblxyXG5cclxuXHJcblxyXG4gICAgICAgIH0pO1xyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuXHJcbiAgICBzYXZlUHVibGljYXRpb24sXHJcbiAgICBnZXRQdWJsaWNhdGlvblRpbWVsaW5lLFxyXG4gICAgZ2V0UHVibGljYXRpb24sXHJcbiAgICBkZWxldGVQdWJsaWNhdGlvbixcclxuICAgIHVwbG9hZEltYWdlLFxyXG4gICAgZ2V0SW1hZ2VGaWxlLFxyXG4gICAgZ2V0UHVibGljYXRpb25zVXNlcixcclxuICAgIGdldFRvcDNDYW5jaW9uZXNQdWJsaWNhZGFzXHJcblxyXG59Il19